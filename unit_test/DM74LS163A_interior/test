DEFINE CUSTOM BLOCK DM74LS163Ajk (
    IN 0PQ 0NPQ 1PQ 2PQ 3PQ NPTNALC NALC DATA CLEAR CLK
    OUT Q NQ
) {
    INSERT BLOCKS
        JK_LATCH l,
        AND and1 Q 1PQ 2PQ 3PQ NPTNALC o,
        AND and2 NALC NJ o,
        AND and3 DATA CLEAR NALC o,
        AND and4 NPTNALC 1PQ 2PQ 3PQ NQ o,
        OR or1 A1 A2 o,
        OR or2 A3 A4 o,
        NOT nq i o,
        VCC vcc
    ;
    INSERT EDGES
        BTWN vcc.val AND (l.PR, l.CLR),

        BTWN and1.o AND or1.A1,
        BTWN and2.o AND or1.A2,
        BTWN and3.o AND or2.A3,
        BTWN and4.o AND or2.A4,
        BTWN or1.o AND l.K,
        BTWN or2.o AND (l.J, nq.i),
        BTWN nq.o AND and2.NJ,

        BTWN THIS.CLK AND l.CLK,
        BTWN THIS.DATA AND and3.DATA,
        BTWN THIS.CLEAR AND and3.CLEAR,

        BTWN THIS.0PQ AND and1.Q,
        BTWN THIS.0NPQ AND and4.NQ,
        BTWN l.Q AND ( THIS.Q),
        BTWN l.NQ AND ( THIS.NQ),

        BTWN THIS.NALC AND (and2.NALC, and3.NALC),

        BTWN THIS.NPTNALC AND (and1.NPTNALC, and4.NPTNALC),

        BTWN THIS.1PQ AND (and1.1PQ, and4.1PQ),
        BTWN THIS.2PQ AND (and1.2PQ, and4.2PQ),
        BTWN THIS.3PQ AND (and1.3PQ, and4.3PQ)
    ;
};

DEFINE CUSTOM BLOCK DM74LS163Awrapper (
    IN DATA ENP ENT LD CLR CLK 1PQ 2PQ 3PQ
    OUT RESULT
) {
INSERT BLOCKS
    CUSTOM DM74LS163Ajk interior,
    NOT NENP i o,
    NOT NENT i o,
    NAND NALC CLR LD o,
    NOR NPTNALC NALC NENP NENT o
;

INSERT EDGES
    BTWN THIS.1PQ AND interior.1PQ,
    BTWN THIS.2PQ AND interior.2PQ,
    BTWN THIS.3PQ AND interior.3PQ,

    BTWN interior.Q AND interior.0PQ,
    BTWN interior.NQ AND interior.0NPQ,
    BTWN NPTNALC.o AND interior.NPTNALC,
    BTWN NALC.o AND interior.NALC,
    BTWN interior.Q AND THIS.RESULT,
    BTWN THIS.CLK AND interior.CLK,
    BTWN THIS.CLR AND interior.CLEAR,
    BTWN THIS.DATA AND interior.DATA,

    BTWN THIS.CLR AND NALC.CLR,
    BTWN THIS.LD AND NALC.LD,
    BTWN NALC.o AND NPTNALC.NALC,

    BTWN THIS.ENP AND NENP.i,
    BTWN THIS.ENT AND NENT.i,
    BTWN NENP.o AND NPTNALC.NENP,
    BTWN NENT.o AND NPTNALC.NENT
    ;
};

INSERT BLOCKS
    STATE OUT DATA1,
    STATE IN RESULT1,
    STATE OUT CLK,
    STATE OUT ENP,
    STATE OUT ENT,
    STATE OUT LD,
    STATE OUT CLR,

    CUSTOM DM74LS163Awrapper dm1,
    VCC vcc;

INSERT EDGES
    BTWN vcc.val AND dm1.1PQ,
    BTWN vcc.val AND dm1.2PQ,
    BTWN vcc.val AND dm1.3PQ,

    BTWN DATA1.val AND dm1.DATA,
    BTWN dm1.RESULT AND RESULT1.val,
    BTWN CLK.val AND dm1.CLK,
    BTWN CLR.val AND dm1.CLR,
    BTWN ENP.val AND dm1.ENP,
    BTWN ENT.val AND dm1.ENT,
    BTWN LD.val AND dm1.LD
    ;


INSERT INIT COND
    (CLR.val=1, LD.val=1,
    DATA1.val=0,
    CLK.val=1, ENP.val=0, ENT.val=0),
    (CLK.val=0, CLR.val=0),
    (CLK.val=1),
    (CLK.val=0, CLR.val=1),
    (CLK.val=1, LD.val=0),
    (CLK.val=0),
    (CLK.val=1, LD.val=1, ENP.val=1, ENT.val=1),
    (CLK.val=0),
    (CLK.val=1),
    (CLK.val=0)
    ;
    /*
    (CLK.val=0),
    (CLK.val=1),
    */

RUN;
SHOW RUN
(
DATA1.val,
RESULT1.val,
CLK.val, ENP.val, ENT.val, LD.val, CLR.val
);
